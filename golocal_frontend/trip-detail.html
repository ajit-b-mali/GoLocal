<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLocal - Trip Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <div id="trip-details-container">
        <h2 id="trip-name">Loading Trip...</h2>
        <p class="text-muted" id="trip-location"></p>
        <hr>
        <p id="trip-description"></p>
        <div class="row">
            <div class="col-md-6">
                <strong>Starts:</strong> <span id="trip-start"></span>
            </div>
            <div class="col-md-6">
                <strong>Ends:</strong> <span id="trip-end"></span>
            </div>
            <div class="col-md-6 mt-2">
                <strong>Estimated Cost:</strong> â‚¹<span id="trip-cost"></span>
            </div>
        </div>
    </div>
    
    <div class="mt-5">
        <h4>Participants</h4>
        <ul id="participants-list" class="list-group">
            </ul>
    </div>

    <div id="add-participant-section" class="card mt-4">
        <div class="card-header">
            <h5>Add Participants</h5>
        </div>
        <div class="card-body">
            <form id="add-participant-form">
                <p>Invite friends with a GoLocal account, or add anyone by email or name for planning.</p>
                <div class="form-group">
                    <label for="participant-email">Participant's Email (optional)</label>
                    <input type="email" class="form-control" id="participant-email" placeholder="friend@example.com">
                </div>
                <div class="form-group">
                    <label for="participant-name">Participant's Name</label>
                    <input type="text" class="form-control" id="participant-name" placeholder="e.g., Arun from Pune">
                </div>
                <button type="submit" class="btn btn-primary">Add to Trip</button>
            </form>
            <div id="invite-response" class="mt-3"></div>
        </div>
    </div>

    <div id="error-view" class="alert alert-danger mt-4" style="display: none;"></div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
    // --- SETUP ---
    var jwt = localStorage.getItem('jwt');
    
    // Get the trip ID from the URL query string
    var urlParams = new URLSearchParams(window.location.search);
    var tripId = urlParams.get('id');

    // API Endpoints
    var tripDetailApiUrl = `http://localhost/golocal_backend/public/api/trips/read_single?id=${tripId}`;
    var participantsApiUrl = `http://localhost/golocal_backend/public/api/trips/read_participants?id=${tripId}`;
    var inviteApiUrl = 'http://localhost/golocal_backend/public/api/trips/invite';

    // If no JWT or tripId, show an error
    if (!jwt || !tripId) {
        $('#error-view').text('Access Denied or invalid trip ID.').show();
        $('#trip-details-container').hide();
        return;
    }

    // --- FUNCTION TO FETCH TRIP DETAILS ---
    function fetchTripDetails() {
        $.ajax({
            url: tripDetailApiUrl,
            type: 'GET',
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + jwt); },
            success: function(trip) {
                $('#trip-name').text(trip.trip_name);
                $('#trip-location').text(trip.location);
                $('#trip-description').text(trip.description);
                $('#trip-start').text(new Date(trip.start_datetime).toLocaleString('en-IN'));
                $('#trip-end').text(new Date(trip.end_datetime).toLocaleString('en-IN'));
                $('#trip-cost').text(trip.estimated_cost || 'N/A');

                if (trip.is_admin) {
                    $('#add-participant-section').show();
                } else {
                    $('#add-participant-section').hide();
                }
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Could not load trip details.";
                $('#error-view').text(errorMsg).show();
            }
        });
    }

    // --- FUNCTION TO FETCH PARTICIPANTS ---
    function fetchParticipants() {
        $.ajax({
            url: participantsApiUrl,
            type: 'GET',
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + jwt); },
            success: function(response) {
                var list = $('#participants-list');
                list.empty();
                if (response.records && response.records.length > 0) {
                    $.each(response.records, function(i, participant) {
                        var participantName = participant.guest_name || 'Unnamed Participant';
                        var participantDetail = participant.guest_email || `Registered User (ID: ${participant.user_id})`;
                        list.append(`<li class="list-group-item">${participantName} <small class="text-muted float-right">${participantDetail}</small></li>`);
                    });
                } else {
                    list.append('<li class="list-group-item">No participants have been added yet.</li>');
                }
            }
        });
    }

    // --- EVENT HANDLER FOR ADDING PARTICIPANTS ---
    $('#add-participant-form').on('submit', function(event) {
        event.preventDefault();
        
        var inviteData = {
            jwt: jwt,
            trip_id: tripId,
            email: $('#participant-email').val(),
            name: $('#participant-name').val()
        };

        $.ajax({
            url: inviteApiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(inviteData),
            success: function(response) {
                $('#invite-response').html('<div class="alert alert-success">' + response.message + '</div>');
                $('#add-participant-form')[0].reset();
                fetchParticipants(); // Refresh the participant list
            },
            error: function(jqXHR) {
                var errorMessage = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'An error occurred.';
                $('#invite-response').html('<div class="alert alert-danger">' + errorMessage + '</div>');
            }
        });
    });

    // --- INITIAL PAGE LOAD ---
    fetchTripDetails();
    fetchParticipants();
});
</script>

</body>
</html>